---
author: Sora Tonami
date: 2025/05/05
description: まずは手始めにエアシリンダーを動かしてみよう！
layout: default
modified: 2025/07/05
title: エアシリンダーを動かしてみよう \| ロボット制御入門 \| 制御講習
title-short: エアシリンダーを動かしてみよう
---

いよいよ前回までで作ったプロジェクトで開発していきます。\
今回はエアシリンダーを動かします。

## ファイル構造について

...とその前に、これから開発していく上でどこに何があるか知っておくと便利です。\
ファイル構造について軽く書いておきます。

![ファイル構造]

赤で囲った部分はCMake関連のファイルです。ライブラリを追加する時には触るかもしれませんが、基本こっちから触ることはありません。\
水色で囲った部分はマイコンがプログラムを起動するために必要なヤツです。これも放置。

重要なのはここからで、黄色・緑で囲った部分(特に後者)を主に触っていきます。

黄色の方、`Inc`はヘッダーファイルを入れておきます。(`Include`の略だろうけど一般的には`include`が使われるので何故`Inc`なのか謎)\
緑の方、`Src`はソースファイルを入れておきます。(`Source code`の略なんだけど一般的には小文字スタートの`src`が使われるのでなんとも)

ヘッダー・ソースの違いは[コラム:ヘッダーとソースの違い]を参照。

その他にもCubeMXでやった設定内容が入ったIOCファイル、ライブラリが入った`Drivers`ディレクトリがありますが、触ることはありません。

## C++を使う準備

もう一つ、CubeMXは現状C言語のコードしか吐いてくれないので、C++で開発するにはちょっと細工してやる必要があります。

細工と言っても簡単な話で、C++で書いた関数をCubeMXが吐いたC言語側で呼べばいいのです。早速書いていきます。

![main.hに関数プロトタイプを追加]

まずヘッダーに関数の定義を書きます。`main.c`から呼び出すんで`main.h`(①)が都合良さそうですね。

中には100行弱書いてますが、その中から赤で囲った「USER CODE BEGIN(END) EFP」(②)を探して下さい。\
今回はこの中に書いていきます。どうせなら見慣れた名前が良かろうということで関数名は*某duino*にあやかって`setup`と`loop`としました。

![main.cに関数呼び出しを追加]

先に呼び出しだけ書いちゃいます。`main.c`(①)を開いて下さい。

例によってその中から「USER CODE BEGIN(END) 2」(②)・「USER CODE BEGIN(END) 3」(③)を探します。\
前者では`setup`を、後者では`loop`を呼び出しておきます。

![ソースファイル作成画面を開く]

次に我々がこれからメインで触っていくことになるC++のソースを作ります。\
まず`Src`の上で右クリック(①)して下さい。メニューが表示されるので、「新規」(②)から「C/C++ ソースファイル」(③)を押します。

![C++ソースファイルを作成]

作成画面が出てくるので名前を決め(①)ます。今回は`cxxmain`としました。\
型(②)はソースファイルの言語です。C++なので`.cpp`(画像では筆者の好みの関係で`.cc`)を選びます。`.c`はC言語、`.cu`はCUDAのソースになってしまいます。

このままではCMakeの対象に入らないので、「ターゲットに追加」(③)にチェックを入れます。\
多分デフォでプロジェクト名と同名のヤツにもチェックが入ってくれてるはずなのでそのまま。他はもちろんチェック無し。

OK(④)で完了するとファイルが作成され、自動で開きます。ここにコードを書いていきます。

```cpp
#include <main.h>

extern "C" {

void setup() {
    // 準備
}

void loop() {
    // ループ処理
}

} // extern "C"
```

`extern "C"`がミソで、コイツを付けることでC言語からも使えるようにします。\
他は某duinoよろしく最初に1回だけ実行する部分とループ処理の2つを定義してます。

あと、この後の説明が色々めんどくなりそーなので以降このファイル`cxxmain.cc`って呼ぶんで各自読み替えてね。(投げやり)

閑話休題。

## エアシリンダーを動かそう！

いよいよ本題のエアシリンダーです。

![エアシリンダーと電磁弁の大まかな動作の流れ]

エアシリンダー(図中央)は電磁弁(図左・右)によって制御されます。\
電磁弁は赤で示した弁を電気で動かす事で、タンクの圧縮空気を送ったり、外に向かって開放したりします。\
制御は単純で、信号のON/OFFで弁を切り替えます。ダントツで一番楽です。

STM32のHAL環境においてGPIOから出力する時は`HAL_GPIO_WritePin`か`HAL_GPIO_TogglePin`を使います。\
`Write`というのは、信号のON/OFFを「ONという状態をピンに書き込む」「OFFという状態をピンに書き込む」と捉えているんですね。\
一方`Toggle`は読んで字の如くON/OFFを切り替えます。

引数は両者とも2つ目までは共通で「どのピンに出力するか」をまず渡してやります。\
`Write`の方だけONなのかOFFなのかを渡してやります。`Toggle`は中に持ってるんで要らんという事です。

例としてはこう。

```cpp
HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, GPIO_PIN_SET);   // PA5(GPIOAの5番ピン)にSET(ON)
HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, GPIO_PIN_RESET); // PA5(同上)にRESET(OFF)
//                GPIO?  GPIO_PIN_?  GPIO_PIN_(RE)SET
HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5);                // PA5(同上)をON/OFF切り替え
```

ON/OFFとはそのまま書かずそれぞれSET/RESETと言ってますね。\
これは内部的には「ONであるか」というフラグで見ているので、そこに1をセットすんのか(0で)リセットすんのか、という風に捉えてるわけですね。

ちなみに、CubeMXでピンに名前を付けることができますが、例えば今回のは何もしてなければ「LD2」と言うピンがあるはずなのでこれを例に取ると、

```cpp
HAL_GPIO_WritePin(LD2_GPIO_Port, LD2_Pin, GPIO_PIN_SET);
//                ???_GPIO_Port  ???_Pin
```

のように書けます。便利。\
なおこのピンはNUCLEO-F446REの基板表面のLEDに繋がっていてデフォルトで出力モードとなってます。折角なのでコレ使います。

お手元の`cxxmain.cc`を開いて下さい。そんで、`loop`の中にカーソルを移動して頂戴。

```cpp
// (略)

void loop() {
    // ループ処理
    // ＞＞＞＞＞ こ↑こ↓ ＜＜＜＜＜
}

// (略)
```

で、ここにON/OFFのコードをぶち込めばON/OFFしてくれるわけです。\
が、このままだともれなく秒間1億回弱ぐらいの速度でON/OFFされちゃいます。これでは、いけませんね。\
なので、ちゃんと待ってあげましょう。

STM32のHAL環境において待ってあげる時は`HAL_Delay`を使ってやります。

```cpp
HAL_Delay(1000);
//            ms
```

この例は1秒待ちます。組み込み開発では大体時間の基本単位がミリ秒な気がします。まぁ丁度いいし妥当。<sup>[要出典]</sup>

まぁ1秒でも良いんですが0.5秒の方が~~絵面が面白い~~なんとなく分かりやすそう<sup>[要検証]</sup>なので0.5秒でやります。\
要するに500ミリ秒ですね。

なので`loop`の中身は、

```cpp
HAL_GPIO_TogglePin(LD2_GPIO_Port, LD2_Pin);
HAL_Delay(500);
```

といった所でしょうかね。ON/OFFを明示的に行うなら、

```cpp
HAL_GPIO_WritePin(LD2_GPIO_Port, LD2_Pin, GPIO_PIN_RESET);
HAL_Delay(500);
HAL_GPIO_WritePin(LD2_GPIO_Port, LD2_Pin, GPIO_PIN_SET);
HAL_Delay(500);
```

みたいに書けばよき。

## 基板にぶち込んでみよう！

プログラム出来たんで基板にぶち込みませう。

(TODO:実行ボタン押してる画像)

上にある実行ボタン(多分①とかになるはず)を押すと勝手にビルドした後、\
OpenOCDが起動して書き込みまでやってくれます。楽。

これだけ。

## 次回予告

今回はエアシリンダーを動かしました。ただのON/OFFという所で気付いたかもしれませんが、実は全く同じ方法でLEDも光らせたり出来ます。\
次回は足回りの肝、モーターを動かします。

[前へ](4)・[次へ](6)

[ロボット制御入門Topへ](..#%E3%83%AD%E3%83%9C%E3%83%83%E3%83%88%E5%88%B6%E5%BE%A1%E5%85%A5%E9%96%80)

[c++ソースファイルを作成]: /assets/lessons/program/cpp-from-c-4.png
[main.cに関数呼び出しを追加]: /assets/lessons/program/cpp-from-c-2.png
[main.hに関数プロトタイプを追加]: /assets/lessons/program/cpp-from-c-1.png
[エアシリンダーと電磁弁の大まかな動作の流れ]: /assets/lessons/program/air-cylinder.png
[コラム:ヘッダーとソースの違い]: column-difference-headers-and-sources
[ソースファイル作成画面を開く]: /assets/lessons/program/cpp-from-c-3.png
[ファイル構造]: /assets/lessons/program/file-structure.png
